---
title: "Methods"
author: Steven Bachman
date: 29th October 2018
output: md_document
---

This document describes methods used in the paper **'Progress, challenges and opportunities for plant Red Listing'**. Each numbered section relates to numbered sections in the manuscript. See section [04_docs](https://github.com/stevenpbachman/RedList_Challenges/tree/master/02_docs) for the manuscript.

### 1. Introduction 

```{r echo=FALSE}
# RL key needed for download. ***change this to your own key- get from iucn.org 
rlkey <- "cf3cf316d5dd72945456d42a633ac92357f6b8039bf1d512cc58e26d6169a8f3" # my key
#rlkey = "9bb4facb6d23f48efbf424bb05c0c1ef1cf6f468393bc745d42179ac4aca5fee" # IUCN key
```

*Total number of taxa on the Red List:*
```{r}
#install.packages("rredlist")
library(rredlist)

# get the total number of taxa
rl_count = rredlist::rl_sp_count(key = rlkey)
rl_count = rl_count$count

# note the version of the Red List
rl_ver = rredlist::rl_version(key = rlkey)
```

**Number of taxa on the Red List = `r rl_count`**


**Red List version = `r rl_ver`**




*Total number of species on the Red List:*
```{r}
# this function will get basic data from the Red List
rl_all_IDs = function(rlkey){
  
  # get page with 10,000   
  i=1
  testcount = 1
  rl = rl_sp(0, key = rlkey)
  rl.all = rl$result
  
  # use 'while' to loop through pages until there are no more pages
  while ((testcount)>'0'){
    test = rl_sp(i, key = rlkey)
    testcount = test$count
    rl.all = rbind(rl.all,test$result)
    i = i+1
  }
return(rl.all)  

}
```

Run the rl_all_IDs function to get the full red list of taxa. 
Subset to remove infra rank and populations to get all species

```{r}
# run rl_all_IDs to get dataframe of all taxa on Red List 
all_taxa = rl_all_IDs(rlkey)
```
     
```{r}     
# subset to remove subspecies and infra ranks
all_RL_species = subset(all_taxa, is.na(all_taxa$infra_rank) & is.na(all_taxa$population))

# Get total number of 'species' on Red List
rl_row = nrow(all_RL_species)
```

**Number of species on the Red List = `r rl_row `**





### 1.1 Gaps in Red List coverage – why the missing species matter
*Percentage of described vertebrate species that have been Red Listed:*

Estimated number of described species of vertebrates, invertebrates, plants and fungi. 
Source: http://cmsdocs.s3.amazonaws.com/summarystats/2018-1_Summary_Stats_Page_Documents/2018_1_RL_Stats_Table_1.pdf

```{r}
# subset all species to get only vertebrates
all.verts = subset(all_RL_species, all_RL_species$phylum_name == "CHORDATA")

# estimated number of described species of VERTEBRATES
described.verts = 69276

# proportion vert species described that have been Red Listed
prop.verts.RL = round((nrow(all.verts)/described.verts)*100, digits = 2)
```

**Proportion of vertebrate species described that have been Red Listed = `r prop.verts.RL `%**



*Percentage of described invertebrates, plants and fungi species that have been Red Listed:*

```{r}
# subset all species to get only plants
all.plants = subset(all_RL_species, all_RL_species$kingdom_name == "PLANTAE") #KINGDOM = PLANTAE
all.plants.count = nrow(all.plants)

# print
print(paste0('Number of plant species Red Listed = ',all.plants.count))
```

**Number of plant species Red Listed = `r all.plants.count `**



```{r}
# fungi and protists covered in two kingdoms so use 'which' and pipe symbol to combine
all.fungi = all_RL_species[ which(all_RL_species$kingdom_name == "FUNGI" | all_RL_species$kingdom_name == "CHROMISTA"),]
all.fungi.count = nrow(all.fungi)
```

**Number of fungi species Red Listed= `r all.fungi.count `**



```{r}
# inverts is any animalia that isn't phylum CHORDATA so use kingdom == ANIMALIA & phylum != CHORDATA
all.inverts = all_RL_species[ which(all_RL_species$kingdom_name == "ANIMALIA" & all_RL_species$phylum_name != "CHORDATA"),]
all.inverts.count = nrow(all.inverts)
```

**Number of invertebrate species Red Listed = `r all.inverts.count `**



```{r}
all.RL.nonverts =  all.plants.count + all.fungi.count + all.inverts.count
```



**Number of != vertebrate species Red Listed = `r all.RL.nonverts `**


Estimated number of described species of invertebrates, plants and fungi. 
Source: http://cmsdocs.s3.amazonaws.com/summarystats/2018-1_Summary_Stats_Page_Documents/2018_1_RL_Stats_Table_1.pdf

For vascular plants source:  
Lughadha, E.M., Govaerts, R., Belayaeva, I., Black, N., Lindon, H., Allkin, R., Magill, R.E., Nicholson, N., 2016. Counting counts: revised estimates of numbers of accepted species of flowering plants, seed plants, vascular plants and land plants with a review of other recent estimates. Phytotaxa 272, 82–88.
https://www.biotaxa.org/Phytotaxa/article/view/phytotaxa.272.1.5

```{r}
described.vasc.plants.niclughadha2016 = 383671
described.fungi = 52280
described.inverts = 1305250
described.nonvert = described.vasc.plants.niclughadha2016 + described.fungi + described.inverts

# proportion described invertebrates, plants and fungi species that have been Red Listed
prop.nonverts.RL = all.RL.nonverts/described.nonvert*100
```

**Proportion of invertebrates described that have been Red Listed = `r round((prop.nonverts.RL), digits = 2) `%**



### 1.2 Growing the Red List - vascular plants as a case study
filter on vascular plants only and compare with best estimate for total number of vascular plants i.e. Nic Lughadha et al 2016
```{r}
vasc_plants = subset(all.plants, all.plants$phylum_name == "TRACHEOPHYTA") #PHYLUM = TRACHEOPHYTA (vascular plants)
nrow(vasc_plants)/described.vasc.plants.niclughadha2016*100
```
**Proportion of vascular plants that have been Red Listed = `r round((nrow(vasc_plants)/described.vasc.plants.niclughadha2016*100), digits = 2)`**

### 2.3 Batch assessment upload with ‘SIS Connect’
Percentage of assessments published on the Red List via SIS Connect
Craig Hilton-Taylor, pers. comm (10th August 2018)

```{r}
sis_connect_pub = 509
sis_connect_pre_pub = 915
```
**Assessments published via SIS Connect = `r sis_connect_pub`**


**Assessments in SIS Connect pipeline = `r sis_connect_pre_pub`**



### 2.4 Inclusion of assessments in languages other than English

List of mega diverse countries derived from this source:
http://www.biodiversitya-z.org/content/megadiverse-countries.pdf

```{r}
# read in table of mega diverse countries
mega_diverse_countries <- read.csv("01_data/mega_diverse countries.csv")

# get the number of megadiverse countries that speak Spanish, Portuguese or French as main language
country.count = nrow(subset(mega_diverse_countries, mega_diverse_countries$Span.Port.or.French == "Yes"))
```
**Number of mega diverse countries that Spanish, Portuguese or French = `r country.count`**



```{r}
# Red list assessments in other languages
brazil_2016_prt = 20
haiti_2018_1_frnch = 38
```



### 2.5 Spatial tools support Red List automation
Craig Hilton-Taylor, pers. comm (10th August 2018)
```{r}
spatial_tools_citations = 1939
```
**Number of publications citing spatial tools =  `r spatial_tools_citations`**



### 2.6 Linking new  species and Red List assessment publications 
To get the average number of new taxa described every year, data were downloaded from IPNI Beta site: https://beta.ipni.org/

A query was made for each year, with a filter on 'Specific' taxa (species). A csv for each year from 1999 - 2017 inclusive was downloaded. See [01_data](https://github.com/stevenpbachman/RedList_Challenges/tree/master/01_data) for raw data.


```{r}
# read in raw files. Thanks to Hayward Godwin: https://www.r-bloggers.com/merge-all-files-in-a-directory-using-r-into-a-single-dataframe/

# get list of files, note full.names = true to get full path
file_list = list.files("01_data/IPNI_downloads_25_07_2018/", full.names = TRUE)

#create first dataset
IPNI_raw <- read.csv("01_data/IPNI_downloads_25_07_2018/citations_1999.txt")

# make blank DF with structure
IPNI_raw = IPNI_raw[0,]

for (file in file_list){
       
# if the merged dataset does exist, append to it
  if (exists("IPNI_raw")){
    temp_dataset <-read.csv(file)
    IPNI_raw = rbind(IPNI_raw, temp_dataset)
    rm(temp_dataset)
  }
}

#head(IPNI_raw)
```

```{r}
# save this down
path = getwd()
respath = paste0(path,"/04_outputs/IPNI_raw.csv")
write.table(IPNI_raw, respath,row.names = FALSE, na="", sep = ",")
```

Subset the IPNI data to just tax.nov.
```{r}
tax.nov = subset(IPNI_raw, IPNI_raw$citation.type == "tax. nov.")
```

Summarise number of tax.nov by year
```{r}
library(tidyverse)
tax.nov.year = tax.nov %>% dplyr::group_by(published) %>% dplyr::count(published)
#tax.nov.year
```

Plot number of newly described taxa per year
```{r}
colnames(tax.nov.year)[which(names(tax.nov.year) == "published")] = "Year"
colnames(tax.nov.year)[which(names(tax.nov.year) == "n")] = "Count"

library(ggplot2)
plot = ggplot(data = tax.nov.year) + 
  geom_col(aes(x = Year, y = Count))
plot
```

```{r}
# get average number of described tax now between 1999 and 2017
tax.nov.year.mean = mean(tax.nov.year$Count)
```

**The discovery of new plants occurs at a fairly consistent rate, with a mean of `r round((tax.nov.year.mean, digits = 2) ` per year (1999 – 2017)**

Kew Bulletin example - how many newly described taxa published in Kew Bulletin from 2003–2017 are currently on the Red List?

```{r}
# get Kew Bull species 2003 - 2017
#create first dataset
KewBull_raw <- read.csv("01_data/IPNI_Kew_Bulletin_IPNI_downloads_25_07_2018/citations_KewBull_2003-2017.txt")

# summarise to just tax.nov
KewBull_tax.nov = subset(KewBull_raw, KewBull_raw$citation.type == "tax. nov.")
nrow(KewBull_tax.nov)

# change column names to match
colnames(KewBull_tax.nov)[which(names(KewBull_tax.nov) == "scientific.name")] = "scientific_name"

# now link to the red list to see how many have been assessed
KB_RL_joined = merge(KewBull_tax.nov, all.plants, by = "scientific_name" )

# Get totals
nrow(KB_RL_joined)
nrow(KB_RL_joined)/nrow(KewBull_tax.nov)*100
```

**Of the 1,234 newly described taxa published in Kew Bulletin from 2003–2017, only `r nrow(KewBull_tax.nov)` `r round((nrow(KB_RL_joined)/nrow(KewBull_tax.nov)*100),digits = 2)` are currently on the Red List**


How much time had elapsed between formal description of a species and publication of an assessment for that species on the Red List? Species described and then assessed within 5 years were labelled as ‘New’, and species that were assessed more than 5 years since they were described were labelled ‘Old’. 

Link the Red List plant names to IPNI so that we can get year of description 
```{r}

# here we run the POWO script against the Red list list of names to get matches. 
# could also try other ways to match - IPNI, TPL via GBIF?

# the rest is just linking IPNI IDs
```



```{r}
# import the RL data with IPNI ID and year
RedList2018_1_powo_species_IPNI_LSID <- read.csv("C:/Users/sb42kg/OneDrive - The Royal Botanic Gardens, Kew/02_Publications/PhD/Major_Corrections/RedList_challenges/01_data/RedList2018_1_powo_species_IPNI_LSID.csv")

IPNI_year = RedList2018_1_powo_species_IPNI_LSID

# change column name so that you can merge with full red list data
colnames(IPNI_year)[which(names(IPNI_year) == "search_name")] = "scientific_name"

# merge IPNI year and Red List 
merged_taxnov_RL = merge(IPNI_year, all.plants.RL_full, by = "scientific_name")

# now take the described year away from the published year
merged_taxnov_RL_diff = data.frame(diff = merged_taxnov_RL$published_year - merged_taxnov_RL$Year)
diff = cbind(merged_taxnov_RL_diff, merged_taxnov_RL)

# now add column for New (5 years or less) and Old (>5 years)
diff$age[diff$diff < 6] <- "New"
diff$age[diff$diff >=6] <- "Old"
diff$age[is.na(diff$diff)] <- "Unknown"

diffplot = subset(diff, published_year > 2002 & published_year <2018, select=c(published_year, age))

# adding in a single record to get a point for 2005 - must be another way to do this...
extralev = data.frame(published_year = "2005", age = "Unknown")
diffplot = rbind(diffplot, extralev)

tax.nov.plot = subset(tax.nov.year, tax.nov.year$Year >="2003" & tax.nov.year$Year < "2018")
RL_vasc_plants = subset(all.plants.RL_full, all.plants.RL_full$phylum == "TRACHEOPHYTA" )

# now summarise the ratio of old and new for each red list assessment year
library(ggplot2)
plot = ggplot() + 
  geom_bar(data = diffplot, aes(x = as.factor(published_year), fill = as.factor(age)), 
           position = position_dodge(preserve = 'single')) + 
  
  labs(x = "Red List Publication Year", y = "Number of plant species assessments", fill = "") +
  theme_minimal() +
  scale_fill_manual(values = c("New" = "#f37735", "Old" = "#ffc425", "Unknown" = "light grey")) +
    geom_point(data = tax.nov.plot, aes(x = as.factor(year), y = Count), stat = "identity", size = 2, shape = 16) +
  #scale_colour_manual(name = "Year", labels = "test", values = "black") +
  scale_x_discrete(expand = c(0, 0)) + scale_y_continuous(expand = c(0,100)) 
  
plot
  
```

### 3.3 Supporting the Plant assessment champions –Specialist Groups and Authorities


